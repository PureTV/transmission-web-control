transmission.torrents={all:null,puased:null,downloading:null,actively:null,searchResult:null,error:null,warning:null,folders:{},status:{},count:0,totalSize:0,loadSimpleInfo:false,activeTorrentCount:0,pausedTorrentCount:0,fields:{base:"id,name,status,hashString,totalSize,percentDone,addedDate,trackerStats,leftUntilDone,rateDownload,rateUpload,recheckProgress,rateDownload,rateUpload,peersGettingFromUs,peersSendingToUs,uploadRatio,uploadedEver,downloadedEver,downloadDir,error,errorString,doneDate,queuePosition,activityDate",
status:"id,status,percentDone,trackerStats,leftUntilDone,rateDownload,rateUpload,rateDownload,rateUpload,peersGettingFromUs,peersSendingToUs,uploadRatio,uploadedEver,downloadedEver,error,errorString,doneDate,queuePosition,activityDate",config:"downloadLimit,downloadLimited,peer-limit,seedIdleLimit,seedIdleMode,seedRatioLimit,seedRatioMode,uploadLimit,uploadLimited"},datas:{},recently:null,removed:null,isRecentlyActive:false,newIds:[],getallids:function(b,e,c){var a=this.fields.base;if(this.loadSimpleInfo&&
this.all)a=this.fields.status;a=a.split(",");$.isArray(c)&&$.unique($.merge(a,c));arguments={fields:a};this.isRecentlyActive=false;if(this.all&&e==undefined){arguments.ids="recently-active";this.isRecentlyActive=true}else if(e)arguments.ids=e;if(!this.all)this.all={};transmission.exec({method:"torrent-get",arguments:arguments},function(g){if(g.result=="success"){transmission.torrents.newIds.length=0;transmission.torrents.loadSimpleInfo=true;transmission.torrents.recently=g.arguments.torrents;transmission.torrents.removed=
g.arguments.removed;transmission.torrents.splitid();b&&b(g.arguments.torrents)}else{transmission.torrents.datas=null;b&&b(null)}})},splitid:function(){this.downloading=[];this.puased=[];this.actively=[];this.error=[];this.warning=[];transmission.downloadDirs=[];var b=transmission._status;this.status={};transmission.trackers={};this.totalSize=0;this.folders={};this.count=0;var e=new Base64,c;for(c in this.recently){var a=this.recently[c];this.datas[a.id]=a}var g=[];for(c in this.removed){a=this.removed[c];
g.push(a)}for(c in this.datas){a=this.datas[c];if(!a)return;if($.inArray(a.id,g)!=-1&&g.length>0){if(this.all[a.id]){this.all[a.id]=null;delete this.all[a.id]}this.datas[c]=null;delete this.datas[c]}else{this.isRecentlyActive&&!this.all[a.id]&&this.newIds.push(a.id);a=$.extend(this.all[a.id],a);if(a.uploadedEver==0&&a.downloadedEver==0)a.uploadRatio="∞";a.infoIsLoading=false;var d=this.status[a.status];this.addTracker(a);if(!d){this.status[a.status]=[];d=this.status[a.status]}this.totalSize+=a.totalSize;
if(a.rateDownload>0&&a.leftUntilDone>0){a.remainingTime=getTotalTime(a.leftUntilDone/a.rateDownload*1E3);a.remainingTimeRaw=Math.floor(a.leftUntilDone/a.rateDownload*1E3)}else if(a.rateDownload==0&&a.leftUntilDone==0&&a.totalSize!=0){a.remainingTime=0;a.remainingTimeRaw=0}else{a.remainingTime="∞";a.remainingTimeRaw=31536E8}d.push(a);a.error!=0&&this.error.push(a);if(a.rateUpload>0||a.rateDownload>0)this.actively.push(a);switch(a.status){case b.stopped:this.puased.push(a);break;case b.download:this.downloading.push(a)}this.all[a.id]=
a;$.inArray(a.downloadDir,transmission.downloadDirs)==-1&&transmission.downloadDirs.push(a.downloadDir);if(transmission.options.getFolders)if(a.downloadDir){d=a.downloadDir.split("/");var j="folders-",h;for(h in d){var f=d[h];if(f!=""){j+=e.encode(f);(f=this.folders[j])||(f={count:0,torrents:[],size:0,nodeid:j});f.torrents.push(a);f.count++;f.size+=a.totalSize;this.folders[j]=f}}}this.count++}}transmission.downloadDirs=transmission.downloadDirs.sort();this.newIds.length>0&&this.getallids(null,this.newIds)},
addTracker:function(b){var e=b.trackerStats,c=false,a=[];b.leecherCount=0;b.seederCount=0;if(e.length>0){for(var g in e){var d=e[g],j=d.lastAnnounceResult.toLowerCase(),h=d.host.getHostName().split(".");$.inArray(h[0],"www,tracker".split(","))!=-1&&h.shift();h=h.join(".");var f="tracker-"+h.replace(/\./g,"-"),i=transmission.trackers[f];if(!i){transmission.trackers[f]={count:0,torrents:[],size:0,connected:true,isBT:e.length>1};i=transmission.trackers[f]}i.name=h;i.nodeid=f;i.host=d.host;if(!d.lastAnnounceSucceeded&&
d.announceState!=transmission._trackerStatus.inactive){c=true;b.warning=d.lastAnnounceResult;if(j=="could not connect to tracker")i.connected=false}if(i.torrents.indexOf(b)==-1){i.torrents.push(b);i.count++;i.size+=b.totalSize}b.leecherCount+=d.leecherCount;b.seederCount+=d.seederCount;a.indexOf(h)==-1&&a.push(h)}if(c){if(b.nextAnnounceTime){if(b.nextAnnounceTime>d.nextAnnounceTime)b.nextAnnounceTime=d.nextAnnounceTime}else b.nextAnnounceTime=d.nextAnnounceTime;this.warning.push(b)}if(b.leecherCount<
0)b.leecherCount=0;if(b.seederCount<0)b.seederCount=0;b.leecher=b.leecherCount+" ("+b.peersGettingFromUs+")";b.seeder=b.seederCount+" ("+b.peersSendingToUs+")";b.trackers=a.join(";")}},getPeers:function(b){transmission.exec({method:"torrent-get",arguments:{fields:"peers,peersFrom".split(","),ids:b}},function(e){console.log("data:",e)})},getMoreInfos:function(b,e,c){transmission.exec({method:"torrent-get",arguments:{fields:b.split(","),ids:e}},function(a){if(a.result=="success")c&&c(a.arguments.torrents);
else c&&c(null)})},search:function(b,e){if(!b)return null;if(!e)e=this.all;var c=[];$.each(e,function(a){e[a].name.toLowerCase().indexOf(b.toLowerCase())!=-1&&c.push(e[a])});return this.searchResult=c},getFiles:function(b,e){transmission.exec({method:"torrent-get",arguments:{fields:"files,fileStats".split(","),ids:b}},function(c){if(c.result=="success")e&&e(c.arguments.torrents);else e&&e(null)})},getConfig:function(b,e){this.getMoreInfos(this.fields.config,b,e)},getErrorIds:function(b,e){var c=[],
a=new Date;if(e==true)a=a.getTime()/1E3;for(var g in this.error){var d=this.error[g];if(!($.inArray(d.id,b)!=-1&&b.length>0)){if(e==true)if(a<d.nextAnnounceTime)continue;d.status!=transmission._status.stopped&&c.push(d.id)}}for(g in this.warning){d=this.warning[g];if(!($.inArray(d.id,b)!=-1&&b.length>0)){if(e==true)if(a<d.nextAnnounceTime)continue;c.push(d.id)}}return c},searchAndReplaceTrackers:function(b,e,c){if(b&&e){var a={},g=0,d;for(d in this.all){var j=this.all[d];if(!j)return;var h=j.trackerStats,
f;for(f in h)if(h[f].announce==b){a[f]||(a[f]={ids:[],tracker:e});a[f].ids.push(j.id);g++}}g==0&&c&&c(null,0);for(d in a)transmission.exec({method:"torrent-set",arguments:{ids:a[d].ids,trackerReplace:[parseInt(d),a[d].tracker]}},function(i,k){if(i.result=="success")c&&c(k,g);else c&&c(null)},a[d].ids)}}};
